<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal Akademik - Cendekia Aksara</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Merriweather:wght@700&display=swap'); /* Untuk Judul KHS */
        @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css');

        :root {
            --primary-color: #005a9c; --secondary-color: #003366; --accent-color: #f7a04a;
            --success-color: #28a745; --danger-color: #dc3545; --light-bg: #f0f4f8;
            --white-color: #ffffff; --gray-color: #6c757d; --light-gray: #e9ecef;
            --dark-text: #343a40; --border-radius: 12px; --shadow: 0 8px 30px rgba(0, 40, 80, 0.1);
            --khs-border-color: #1a365d; /* Biru tua untuk border KHS */
        }

        body {
            font-family: 'Poppins', sans-serif; background-color: var(--light-bg); margin: 0;
            padding: 20px; color: var(--dark-text); line-height: 1.6;
        }

        .container {
            max-width: 800px; margin: auto; background: var(--white-color); padding: 30px;
            border-radius: var(--border-radius); box-shadow: var(--shadow); overflow: hidden; position: relative;
        }

        .header {
            text-align: center; margin-bottom: 30px; padding-bottom: 20px;
            border-bottom: 2px solid var(--light-gray);
        }
        .header h1 {
            color: var(--secondary-color); margin: 0; font-size: 2.2em; display: flex;
            align-items: center; justify-content: center; gap: 10px;
        }
        .header h1 i { color: var(--accent-color); }
        .header p { color: var(--gray-color); margin-top: 5px; }

        .hidden { display: none !important; }

        .btn {
            display: inline-block; width: 100%; padding: 12px 20px; border: none;
            border-radius: 8px; color: var(--white-color); background-color: var(--primary-color);
            font-weight: 600; cursor: pointer; text-align: center; transition: all 0.3s ease; box-sizing: border-box; text-decoration: none;
        }
        .btn:hover:not(:disabled) { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0, 90, 156, 0.3); }
        .btn:disabled { background-color: var(--gray-color); cursor: not-allowed; }
        .btn-success { background-color: var(--success-color); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-secondary { background-color: var(--gray-color); }
        .btn-icon { width: auto; }
        .btn-sm { padding: 8px 12px; font-size: 0.9em; }

        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-weight: 600; margin-bottom: 8px; }
        .form-group input, .form-group select, .form-group textarea, .form-control {
            width: 100%; padding: 12px; border: 1px solid #ccc;
            border-radius: 8px; box-sizing: border-box; transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus, .form-control:focus { outline: none; border-color: var(--primary-color); }
        .toggle-auth { text-align: center; margin-top: 15px; cursor: pointer; color: var(--primary-color); font-weight: 500; }

        h2, h3 { color: var(--secondary-color); text-align: center; }

        .dashboard-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-top: 20px; }
        .dashboard-card {
            background-color: var(--secondary-color); color: var(--white-color);
            padding: 30px; border-radius: var(--border-radius); text-align: center;
            cursor: pointer; transition: all 0.3s ease; text-decoration: none;
        }
        .dashboard-card:hover { transform: translateY(-5px) scale(1.03); box-shadow: 0 12px 25px rgba(0, 0, 0, 0.15); }
        .dashboard-card i { font-size: 3em; margin-bottom: 15px; }
        .dashboard-card h3 { color: var(--white-color); margin: 0; }
        .dashboard-card.tugas { background-image: linear-gradient(45deg, #005a9c, #007bff); }
        .dashboard-card.kuis { background-image: linear-gradient(45deg, #28a745, #20c997); }
        .dashboard-card.ujian { background-image: linear-gradient(45deg, #f7a04a, #ffc107); }
        .dashboard-card.review { background-image: linear-gradient(45deg, #6610f2, #6f42c1); }
        .dashboard-card.profil { background-image: linear-gradient(45deg, #17a2b8, #20c997); }
        .dashboard-card.kelola-profil { background-image: linear-gradient(45deg, #343a40, #6c757d); }
        .dashboard-card.kartu-studi { background-image: linear-gradient(45deg, #6f42c1, #e83e8c); }
        /* [BARU] Style untuk kartu arsip admin */
        .dashboard-card.arsip { background-image: linear-gradient(45deg, #374151, #1f2937); }

        /* --- STYLE KHUSUS KHS (Sesuai Gambar Referensi & Paten Ukuran) --- */
        /* Wrapper agar bisa discroll di mobile */
        .khs-wrapper {
            width: 100%;
            overflow-x: auto; /* Scroll horizontal jika layar sempit */
            padding: 10px 0;
            background-color: #f5f5f5; /* Background abu biar kartu menonjol */
            border-radius: 8px;
            display: flex;
            justify-content: center; /* Center jika layar lebar */
        }

        .khs-container {
            background: white;
            border: 5px solid var(--khs-border-color);
            padding: 40px 30px 20px 30px;
            font-family: 'Times New Roman', serif;
            color: black;
            position: relative;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            
            /* --- [REVISI] UKURAN PATEN A5 --- */
            /* A5 = 148mm x 210mm. Konversi ke px (approx 96dpi) => 560px width */
            /* Menggunakan width tetap agar tidak mengecil di mobile */
            width: 560px; 
            min-width: 560px; /* Paksa minimal segini */
            min-height: 794px; /* Proporsi tinggi A5 */
            box-sizing: border-box; /* Agar padding tidak menambah lebar total */
            margin: 0 auto; /* Tengah */
        }
        
        .khs-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .khs-header h2 {
            font-family: 'Merriweather', serif;
            font-size: 24pt;
            color: var(--khs-border-color);
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .khs-header p {
            font-family: 'Times New Roman', serif;
            font-size: 14pt;
            font-weight: bold;
            color: var(--khs-border-color);
            margin: 5px 0 0 0;
        }

        .khs-student-info {
            margin-bottom: 20px;
            font-size: 12pt;
            font-weight: bold;
            color: var(--khs-border-color);
        }
        
        .khs-student-info table {
            width: 100%;
            border: none;
        }
        
        .khs-student-info td {
            padding: 2px 0;
            vertical-align: top;
        }
        
        .khs-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            border: 2px solid var(--khs-border-color);
        }
        
        .khs-table th, .khs-table td {
            border: 2px solid var(--khs-border-color);
            padding: 8px 5px;
            text-align: center;
            font-size: 11pt;
        }
        
        .khs-table th {
            background-color: var(--khs-border-color);
            color: white;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .khs-table td:nth-child(2) {
            text-align: center;
        }

        .khs-watermark {
            position: absolute;
            top: 55%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0.08;
            z-index: 0;
            width: 250px;
            height: auto;
            pointer-events: none;
        }

        .khs-footer {
            margin-top: 20px;
            font-weight: bold;
            color: var(--khs-border-color);
            font-size: 12pt;
        }

        .khs-signature-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .signature-box {
            text-align: center;
            width: 250px;
            color: var(--khs-border-color);
            position: relative;
        }
        
        .signature-stamp {
            position: absolute;
            top: 0px;
            left: 50%;
            transform: translateX(-50%) rotate(-5deg);
            width: 110px;
            height: auto;
            z-index: 1;
        }

        .khs-bottom-bar {
            background-color: var(--khs-border-color);
            color: white;
            padding: 10px 15px;
            font-size: 9pt;
            text-align: left;
            margin-top: 20px;
            /* Melebarkan bar ke kiri dan kanan container */
            margin-left: -30px;
            margin-right: -30px;
            margin-bottom: -20px; /* Menempel ke bawah */
            font-family: 'Poppins', sans-serif;
        }

        .item-card, .grading-card {
            border: 1px solid var(--light-gray); padding: 20px; border-radius: var(--border-radius); margin-bottom: 15px;
            background: #fdfdfd; transition: all 0.3s ease; animation: fadeIn 0.5s ease; position: relative;
        }
        .item-card.clickable { cursor: pointer; }
        .item-card.clickable:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.08); border-left: 5px solid var(--accent-color); }
        .card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .card-header h3 { margin: 0 0 10px; text-align: left; color: var(--secondary-color); }
        .item-card p, .grading-card p { text-align: left; margin: 4px 0; font-size: 0.9em; color: var(--gray-color); }
        .card-actions { display: flex; gap: 10px; margin-top: 15px; }
        .tag { display: inline-block; padding: 4px 12px; border-radius: 50px; font-size: 0.8em; font-weight: 600; color: var(--white-color); }
        .tag-green { background-color: var(--success-color); }
        .tag-blue { background-color: var(--primary-color); }
        .tag-gray { background-color: var(--gray-color); }
        .tag-orange { background-color: var(--accent-color); }
        .tag-red { background-color: var(--danger-color); }
        .submitted-icon { position: absolute; top: 15px; right: 15px; font-size: 1.5em; color: var(--success-color); }
        .grading-card .form-group { display: flex; gap: 15px; align-items: center; }
        .grading-card .form-group input { width: 100px; }
        .grading-card .form-group textarea { flex: 1; }
        .grading-card-footer { text-align: right; }
        .download-link { padding: 5px 10px; font-size: 0.9em; text-decoration: none; display: inline-flex; align-items: center; gap: 8px; }

        .submission-success-view { text-align: center; padding: 40px 20px; border: 2px dashed var(--success-color); border-radius: var(--border-radius); background-color: #f8fdfd; }
        .submission-success-view i { font-size: 3em; color: var(--success-color); margin-bottom: 20px; }
        .submission-success-view h3 { color: var(--secondary-color); }
        .submission-success-view p { color: var(--dark-text); font-style: italic; }
        .submission-success-view button { margin-top: 20px; }

        .profile-info { text-align: center; }
        .profile-pic { 
            width: 120px; 
            height: 120px; 
            border-radius: 50%; 
            margin: 0 auto 20px auto; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 2.5em; 
            font-weight: bold;
            color: white;
            position: relative;
            transition: all 0.3s ease;
        }
        .profile-pic.good { background: linear-gradient(135deg, #28a745, #20c997); }
        .profile-pic.warning { 
            background: linear-gradient(135deg, #f7a04a, #ffc107); 
            animation: pulse 2s infinite;
        }
        .profile-pic.warning::after {
            content: '\f071';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            position: absolute;
            bottom: -10px;
            right: -5px;
            background: var(--danger-color);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        
        .ips-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 12px;
            margin-top: 15px;
            color: #856404;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .ips-warning i {
            color: var(--accent-color);
            font-size: 1.2em;
        }
        
        .profile-info h3 { margin: 0; }
        .profile-info p { color: var(--gray-color); margin-bottom: 25px; }
        .profile-details { text-align: left; }
        .profile-details .detail-item { display: flex; justify-content: space-between; padding: 15px 0; border-bottom: 1px solid var(--light-gray); }
        .profile-details .detail-item strong { color: var(--dark-text); }
        .profile-details .detail-item span { color: var(--primary-color); font-weight: 600; }

        #search-user-input {
            width: 100%; box-sizing: border-box; padding: 12px;
            border: 1px solid #ccc; border-radius: 8px; margin-bottom: 20px;
        }
        /* Style untuk form tambah siswa */
        #add-student-form {
            display: flex; gap: 10px; margin-bottom: 20px; padding: 15px;
            background-color: var(--light-bg); border-radius: 8px;
        }
        #add-student-email { flex-grow: 1; margin-bottom: 0 !important; /* Override form-group margin */ }
        #add-student-btn { width: auto; flex-shrink: 0; }

        .user-profile-card { border: 1px solid var(--light-gray); border-radius: 8px; padding: 15px; margin-bottom: 10px; }
        .user-profile-card h4 { margin: 0 0 10px 0; text-align: left; }
        .user-profile-card .form-group {
            display: flex; flex-wrap: wrap; gap: 10px; align-items: center;
        }
        .user-profile-card .form-group input[type="number"] { width: 80px; }
        .user-profile-card .form-group button { width: auto; }
        .user-profile-card .form-group label {
            flex-basis: 100px;
            font-weight: 600; margin-bottom: 0;
        }

        /* [BARU] Style untuk tabel arsip admin */
        .log-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .log-table th, .log-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        .log-table th {
            background-color: var(--secondary-color);
            color: white;
        }
        .log-table tr:nth-child(even) { background-color: #f9f9f9; }
        .log-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.8em;
        }
        .log-view { background-color: #e3f2fd; color: #0d47a1; }
        .log-download { background-color: #e8f5e9; color: #1b5e20; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(255, 255, 255, 0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .progress-spinner { width: 60px; height: 60px; border-radius: 50%; border: 4px solid var(--light-gray); border-top-color: var(--primary-color); animation: spin 1s linear infinite; }
        #loading-overlay p { margin-top: 20px; font-size: 1.2em; font-weight: 600; color: var(--secondary-color); }
        @keyframes spin { to { transform: rotate(360deg); } }

        .modal { position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; }
        .modal-content { background-color: #fefefe; margin: auto; padding: 25px; border: 1px solid #888; width: 90%; max-width: 500px; border-radius: var(--border-radius); box-shadow: var(--shadow); animation: fadeIn 0.3s; }
        .modal-header { padding-bottom: 10px; border-bottom: 1px solid #eee; margin-bottom: 15px; }
        .modal-header h2 { margin: 0; text-align: left; font-size: 1.5em; }
        .modal-body { margin-bottom: 20px; }
        .modal-footer { text-align: right; }
        .modal-footer button { width: auto; margin-left: 10px; }

        @media (max-width: 768px) {
            body { padding: 0; }
            .container {
                box-shadow: none; border-radius: 0; padding: 20px 15px; min-height: 100vh;
            }
            .header h1 { font-size: 1.8em; }
            h2 { font-size: 1.4em; }
            .dashboard-grid { grid-template-columns: 1fr; gap: 15px; }
            .dashboard-card { padding: 25px; }
            .item-card, .grading-card { padding: 15px; }
            .btn { padding: 14px 20px; }
            .card-header { flex-direction: column; align-items: flex-start; }
            .card-actions { margin-top: 10px; }
            #add-student-form { flex-direction: column; }
            #add-student-btn { width: 100%; }
            .report-header { flex-direction: column; align-items: flex-start; gap: 10px; }
            .report-summary { flex-direction: column; align-items: flex-end; }
            .summary-box { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="main-header"><i class="fa-solid fa-book-open-reader"></i> Cendekia Aksara</h1>
            <p id="sub-header">Portal Akademik Terpadu</p>
        </div>

        <!-- Tampilan Autentikasi -->
        <div id="auth-view" class="view">
            <div id="login-form-container">
                <h2>Masuk ke Portal</h2>
                <form id="login-form">
                    <div class="form-group"><label for="username">Email</label><input type="email" id="username" required></div>
                    <div class="form-group"><label for="password">Password</label><input type="password" id="password" required></div>
                    <button type="submit" class="btn">Login</button>
                </form>
                <p class="toggle-auth" id="show-register-link">Belum punya akun? Daftar di sini.</p>
            </div>
            <div id="register-form-container" class="hidden">
                <h2>Daftar Akun Baru</h2>
                <form id="register-form">
                    <div class="form-group"><label for="register-name">Nama Lengkap</label><input type="text" id="register-name" required></div>
                    <div class="form-group"><label for="register-email">Email</label><input type="email" id="register-email" required></div>
                    <div class="form-group"><label for="register-password">Password</label><input type="password" id="register-password" required minlength="6"></div>
                    <button type="submit" class="btn">Daftar</button>
                </form>
                <p class="toggle-auth" id="show-login-link">Sudah punya akun? Masuk di sini.</p>
            </div>
        </div>

        <!-- Tampilan Dasbor Utama (Siswa) -->
        <div id="dashboard-view" class="view hidden">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="welcome-user" style="text-align:left; margin:0;"></h2>
                <button id="logout-btn" class="btn btn-danger btn-icon" title="Logout"><i class="fa-solid fa-right-from-bracket"></i></button>
            </div>
            <div id="main-dashboard-grid" class="dashboard-grid">
                <div class="dashboard-card tugas" id="tugas-menu"> <i class="fa-solid fa-pencil-alt"></i> <h3>Tugas Harian</h3> </div>
                <div class="dashboard-card profil" id="profil-menu"> <i class="fa-solid fa-user"></i> <h3>Profil Saya</h3> </div>
                <!-- [BARU] Menu Kartu Studi -->
                <div class="dashboard-card kartu-studi" id="kartu-studi-menu"> <i class="fa-solid fa-graduation-cap"></i> <h3>Kartu Studi</h3> </div>
                <a href="https://bhe-24.github.io/PortalKuis/" target="_blank" class="dashboard-card kuis"> <i class="fa-solid fa-list-check"></i> <h3>Portal Kuis</h3> </a>
                <a href="https://bhe-24.github.io/PortalUjian/" target="_blank" class="dashboard-card ujian"> <i class="fa-solid fa-stopwatch"></i> <h3>Portal Ujian</h3> </a>
            </div>
        </div>

        <!-- HALAMAN SISWA -->
        <div id="tugas-view" class="view hidden">
            <button class="btn btn-secondary back-to-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Daftar Tugas Harian</h2>
            <div id="assignment-list-siswa"></div>
        </div>
        <div id="task-detail-view" class="view hidden"></div>
        <div id="profil-view" class="view hidden">
            <button class="btn btn-secondary back-to-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Profil Saya</h2>
            <div id="profil-content" class="profile-info"></div>
        </div>
        <!-- [BARU] Halaman Kartu Studi -->
        <div id="kartu-studi-view" class="view hidden">
            <button class="btn btn-secondary back-to-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <div id="kartu-studi-content"></div>
        </div>

        <!-- HALAMAN ADMIN -->
        <div id="admin-dashboard-view" class="view hidden">
            <h2 id="welcome-admin" style="text-align:left; margin:0 0 20px 0;"></h2>
            <div class="dashboard-grid">
                <div class="dashboard-card tugas" id="admin-tugas-menu"> <i class="fa-solid fa-cogs"></i> <h3>Kelola Tugas Harian</h3> </div>
                <div class="dashboard-card review" id="admin-penilaian-menu"> <i class="fa-solid fa-marker"></i> <h3>Beri Nilai Tugas</h3> </div>
                <div class="dashboard-card kelola-profil" id="admin-profil-menu"> <i class="fa-solid fa-users-cog"></i> <h3>Kelola Profil Siswa</h3> </div>
                <div class="dashboard-card profil" id="admin-data-diri-menu"> <i class="fa-solid fa-address-card"></i> <h3>Data Diri Siswa</h3> </div>
                <!-- [BARU] Menu Arsip KHS untuk Admin -->
                <div class="dashboard-card arsip" id="admin-arsip-menu"> <i class="fa-solid fa-file-invoice"></i> <h3>Arsip Akses KHS</h3> </div>
                <a href="https://bhe-24.github.io/PortalKuis/" target="_blank" class="dashboard-card kuis"> <i class="fa-solid fa-list-check"></i> <h3>Kelola Kuis</h3> </a>
                <a href="https://bhe-24.github.io/PortalUjian/" target="_blank" class="dashboard-card ujian"> <i class="fa-solid fa-file-signature"></i> <h3>Kelola Ujian</h3> </a>
            </div>
            <div style="text-align: center; margin-top: 30px;">
                <button id="admin-logout-btn" class="btn btn-danger" style="width:auto;">Logout</button>
            </div>
        </div>
        <div id="admin-tugas-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Kelola Tugas Harian</h2>
            <div id="admin-tugas-harian-list-admin"></div> <hr style="margin: 30px 0;">
            <h3><i class="fa-solid fa-plus-circle"></i> Buat/Edit Tugas</h3>
            <form id="create-assignment-form">
                <input type="hidden" id="edit-task-id">
                <div class="form-group"><label for="judul-tugas">Judul Tugas</label><input type="text" id="judul-tugas" required></div>
                <div class="form-group"><label for="matkul-tugas">Mata Pelajaran</label><input type="text" id="matkul-tugas" required></div>
                <div class="form-group"><label for="tipe-tugas">Tipe Tugas</label><select id="tipe-tugas" class="form-control"><option value="Esai">Esai</option><option value="Dokumen">Dokumen</option></select></div>
                <div class="form-group"><label for="instruksi-tugas">Instruksi</label><textarea id="instruksi-tugas" rows="4" required></textarea></div>
                <div class="form-group"><label for="deadline-tugas">Deadline</label><input type="datetime-local" id="deadline-tugas" class="form-control" required></div>
                
                <!-- [BARU] Tambahan Semester -->
                <div class="form-group">
                    <label for="semester-tugas">Semester</label>
                    <select id="semester-tugas" class="form-control" required>
                        <option value="1">Semester 1</option>
                        <option value="2">Semester 2</option>
                        <option value="3">Semester 3</option>
                    </select>
                </div>
                <!-- [AKHIR] Tambahan Semester -->
                
                <button type="submit" class="btn btn-success">Simpan Tugas</button>
                <button type="button" id="cancel-edit-task-btn" class="btn btn-secondary hidden" style="margin-top:10px;">Batal Edit</button>
            </form>
        </div>
        <div id="admin-penilaian-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Beri Nilai Tugas Harian</h2>
            <div class="form-group">
                <label for="grading-assignment-selector">Pilih Tugas untuk Dinilai:</label>
                <select id="grading-assignment-selector" class="form-control"></select>
            </div>
            <div id="student-grading-list"></div>
        </div>
        <div id="admin-profil-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Kelola Profil Siswa</h2>
            <!-- --- FORM TAMBAH SISWA BARU --- -->
            <form id="add-student-form">
                <input type="email" id="add-student-email" class="form-control" placeholder="Masukkan email siswa..." required>
                <button type="submit" id="add-student-btn" class="btn btn-sm btn-success"><i class="fa-solid fa-plus"></i> Cari & Tambah Siswa</button>
            </form>
            <hr style="margin: 20px 0;">
            <!-- --- AKHIR FORM --- -->
            <input type="text" id="search-user-input" class="form-control" placeholder="Saring nama atau email siswa...">
            <div id="user-profile-list" style="max-height: 400px; overflow-y: auto;"></div>
        </div>

        <div id="admin-data-diri-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Data Diri Siswa</h2>
            <div id="data-diri-list"></div>
        </div>

        <!-- [BARU] Halaman Arsip Admin -->
        <div id="admin-arsip-view" class="view hidden">
            <button class="btn btn-secondary back-to-admin-dashboard" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>
            <h2>Arsip Aktivitas KHS</h2>
            <p style="text-align: center; color: var(--gray-color); margin-bottom: 20px;">Memantau akses dan pengunduhan Kartu Hasil Studi siswa.</p>
            <div style="overflow-x: auto;">
                <table class="log-table">
                    <thead>
                        <tr>
                            <th>Waktu</th>
                            <th>Nama Siswa</th>
                            <th>Aktivitas</th>
                            <th>Detail</th>
                        </tr>
                    </thead>
                    <tbody id="arsip-list-body">
                        <!-- Data logs akan di-render di sini -->
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <!-- Elemen UI Tambahan -->
    <div id="loading-overlay" class="hidden"><div class="progress-spinner"></div><p id="loading-text">Memuat...</p></div>
    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <div class="modal-header"><h2 id="modal-title">Judul Modal</h2></div>
            <div class="modal-body" id="modal-body-content"><p id="modal-text">Teks modal di sini.</p></div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="btn btn-secondary">Batal</button>
                <button id="modal-confirm-btn" class="btn">OK</button>
            </div>
        </div>
    </div>

    <!-- Script HTML2Canvas untuk Screenshot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script type="module">
    // --- [MIGRASI v9+] Impor Firebase modular ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        onAuthStateChanged, 
        signInWithEmailAndPassword, 
        createUserWithEmailAndPassword,
        signOut 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        doc, 
        getDoc, 
        setDoc, 
        updateDoc, 
        deleteDoc, 
        collection, 
        query, 
        where, 
        addDoc, 
        orderBy, 
        limit,
        serverTimestamp,
        getDocs
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { 
        getStorage, 
        ref, 
        uploadBytes, 
        getDownloadURL 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";


    // --- KONFIGURASI FIREBASE ---
    // [PATH v9+] Konfigurasi tetap sama
    const firebaseConfig = { 
        apiKey: "AIzaSyDpUWUIzPXIZN6rrNtsIqcL6VfOE2RLVl0", 
        authDomain: "mading-cf676.firebaseapp.com", 
        projectId: "mading-cf676", 
        storageBucket: "mading-cf676.firebasestorage.app", 
        messagingSenderId: "72175203671", 
        appId: "1:72175203671:web:7a0676a55beb64bc96ba12" 
    };
    
    // [SINTAKS v9+] Inisialisasi Firebase v9+
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // --- VARIABEL GLOBAL ---
    let currentUserData = null;
    let studentSubmissions = {};
    let allStudentsCache = []; // Cache SEMUA siswa
    let displayedStudents = []; // Siswa yang sedang ditampilkan

    // --- ELEMEN DOM ---
    const loadingOverlay = document.getElementById('loading-overlay');
    const loadingText = document.getElementById('loading-text');

    // --- FUNGSI UTILITAS ---
    const showLoading = (message) => { loadingText.textContent = message; loadingOverlay.classList.remove('hidden'); };
    const hideLoading = () => loadingOverlay.classList.add('hidden');
    
    // [MODIFIKASI] Fungsi helper untuk mengubah newline (\n) menjadi <br>
    const nl2br = (str) => {
        if (!str) return '<i>(Tidak ada jawaban)</i>';
        // 1. Escape HTML entities dulu untuk keamanan
        let safeStr = str.replace(/&/g, "&amp;")
                         .replace(/</g, "&lt;")
                         .replace(/>/g, "&gt;")
                         .replace(/"/g, "&quot;")
                         .replace(/'/g, "&#039;");
        // 2. Baru ganti newline dengan <br>
        return safeStr.replace(/\n/g, '<br>');
    }

    const updateView = (targetId) => {
        document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
        const targetView = document.getElementById(targetId);
        if (targetView) targetView.classList.remove('hidden');
        else console.error(`View with ID ${targetId} not found.`);
    };

    // --- CUSTOM MODAL DIALOG ---
    function showModal(title, text, isConfirm = false) {
        const modal = document.getElementById('custom-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBodyContent = document.getElementById('modal-body-content');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        modalTitle.textContent = title;
        modalBodyContent.innerHTML = text;
        modalCancelBtn.style.display = isConfirm ? 'inline-block' : 'none';
        modalConfirmBtn.textContent = isConfirm ? 'OK' : 'Tutup';
        modal.classList.remove('hidden');

        return new Promise(resolve => {
            modalConfirmBtn.onclick = () => { modal.classList.add('hidden'); resolve(true); };
            modalCancelBtn.onclick = () => { modal.classList.add('hidden'); resolve(false); };
        });
    }

    // --- LOGIC AUTENTIKASI ---
    // [SINTAKS v9+] Menggunakan onAuthStateChanged(auth, ...)
    onAuthStateChanged(auth, async (user) => {
        showLoading('Mengecek sesi...');
        if (user) {
            try {
                // [PATH v9+ & SINTAKS v9+] Menggunakan doc() dan getDoc()
                const docRef = doc(db, 'users', user.uid); // (DIKEMBALIKAN)
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    let userData = docSnap.data();
                    
                    // [FIX] Mengatasi bug toFixed jika IPS tersimpan sebagai string
                    if (typeof userData.ips === 'string') {
                        userData.ips = parseFloat(userData.ips) || 0;
                    }

                    const isSupposedToBeAdmin = user.email.toLowerCase().endsWith('@ac.id');
                    if (isSupposedToBeAdmin && userData.role !== 'pengajar') {
                        // [SINTAKS v9+] Menggunakan updateDoc()
                        await updateDoc(docRef, { role: 'pengajar' });
                        userData.role = 'pengajar';
                    }

                    if (userData.role === 'siswa' && (userData.semester === undefined || userData.ips === undefined)) {
                        // [SINTAKS v9+] Menggunakan setDoc() dengan { merge: true }
                        await setDoc(docRef, {
                            semester: userData.semester || 1,
                            ips: userData.ips || 0
                        }, { merge: true });
                        userData.semester = userData.semester || 1;
                        userData.ips = userData.ips || 0;
                    }

                    currentUserData = { uid: user.uid, ...userData };
                    renderDashboardView();
                } else {
                    // [SINTAKS v9+] Menggunakan signOut(auth)
                    await signOut(auth);
                    showModal('Akun Bermasalah', 'Data akun tidak ditemukan.');
                }
            } catch (err) {
                // [SINTAKS v9+] Menggunakan signOut(auth)
                await signOut(auth);
                showModal('Error', 'Gagal mengambil data akun.');
                console.error("Auth state change error:", err);
            }
        } else {
            currentUserData = null;
            updateView('auth-view');
            hideLoading();
        }
    });

    document.getElementById('show-register-link').onclick = () => { document.getElementById('login-form-container').classList.add('hidden'); document.getElementById('register-form-container').classList.remove('hidden'); };
    document.getElementById('show-login-link').onclick = () => { document.getElementById('register-form-container').classList.add('hidden'); document.getElementById('login-form-container').classList.remove('hidden'); };
    
    document.getElementById('login-form').onsubmit = e => { 
        e.preventDefault(); 
        showLoading('Memverifikasi...'); 
        const email = document.getElementById('username').value; 
        const password = document.getElementById('password').value; 
        // [SINTAKS v9+] Menggunakan signInWithEmailAndPassword(auth, ...)
        signInWithEmailAndPassword(auth, email, password)
            .catch(err => {
                showModal('Login Gagal', 'Kombinasi email dan password tidak cocok.');
                hideLoading(); // [FIX] Sembunyikan loading HANYA JIKA GAGAL
            });
            // [FIX] .finally() dihapus agar loading tetap menyala saat sukses,
            // lalu akan diambil alih oleh 'Mengecek sesi...' dari onAuthStateChanged
    };
    
    document.getElementById('register-form').onsubmit = e => { 
        e.preventDefault(); 
        showLoading('Mendaftarkan akun...'); 
        const name = document.getElementById('register-name').value; 
        const email = document.getElementById('register-email').value; 
        const password = document.getElementById('register-password').value; 
        const userRole = email.toLowerCase().endsWith('@ac.id') ? 'pengajar' : 'siswa'; 
        // [SINTAKS v9+] Menggunakan createUserWithEmailAndPassword(auth, ...)
        createUserWithEmailAndPassword(auth, email, password)
            .then(cred => { 
                const newUser = { name: name, email: email, role: userRole }; 
                // [PATH v9+ & SINTAKS v9+] Menggunakan setDoc(doc(db, ...))
                return setDoc(doc(db, 'users', cred.user.uid), newUser); // (DIKEMBALIKAN)
            }).then(() => { 
                showModal('Pendaftaran Berhasil', 'Akun telah dibuat. Silakan login.'); 
                document.getElementById('show-login-link').click(); 
            }).catch(err => { 
                let message = 'Terjadi kesalahan.'; 
                if (err.code === 'auth/email-already-in-use') message = 'Email ini sudah terdaftar.'; 
                showModal('Pendaftaran Gagal', message); 
            }).finally(() => hideLoading()); 
    };

    // [SINTAKS v9+] Menggunakan signOut(auth)
    document.getElementById('logout-btn').onclick = () => signOut(auth);
    document.getElementById('admin-logout-btn').onclick = () => signOut(auth);
    document.querySelectorAll('.back-to-dashboard').forEach(btn => btn.onclick = renderDashboardView);
    document.querySelectorAll('.back-to-admin-dashboard').forEach(btn => btn.onclick = () => updateView('admin-dashboard-view'));

    // --- FUNGSI RENDER VIEW ---
    function renderDashboardView() {
        if (!currentUserData) { hideLoading(); return; }
        
        if (currentUserData.role === 'pengajar') {
            document.getElementById('welcome-admin').textContent = `Dasbor Admin: ${currentUserData.name}`;
            updateView('admin-dashboard-view');
        
        } else {
            document.getElementById('welcome-user').textContent = `Selamat Datang, ${currentUserData.name}!`;
            
            // [MODIFIKASI] Cek kelengkapan data diri siswa
            // Kita anggap 'noHp' dan 'alamat' adalah field wajib
            const isDataLengkap = currentUserData.noHp && currentUserData.alamat; 
            
            if (!isDataLengkap) {
                // Jika data tidak lengkap, paksa tampilkan halaman profil
                renderProfilView();
                // Tampilkan modal peringatan (setelah sedikit delay agar transisi view selesai)
                setTimeout(() => showModal('Data Diri Belum Lengkap', 'Silakan lengkapi data diri Anda di bawah ini untuk dapat mengakses portal.'), 200);
            } else {
                // Jika lengkap, tampilkan dasbor
                updateView('dashboard-view');
            }
        }
        hideLoading();
    }

    // --- EVENT LISTENER MENU SISWA ---
    document.getElementById('tugas-menu').onclick = () => renderTugasView();
    document.getElementById('profil-menu').onclick = () => renderProfilView();
    // [BARU] Listener Kartu Studi
    document.getElementById('kartu-studi-menu').onclick = () => renderKartuStudiView();

    // --- EVENT LISTENER MENU ADMIN ---
    document.getElementById('admin-tugas-menu').onclick = () => renderAdminTugasView();
    document.getElementById('admin-penilaian-menu').onclick = () => renderAdminPenilaianView();
    document.getElementById('admin-profil-menu').onclick = () => renderAdminProfilView();
    // [BARU] Listener untuk menu data diri admin
    document.getElementById('admin-data-diri-menu').onclick = () => renderAdminDataDiriView();
    // [BARU] Listener untuk menu Arsip KHS admin
    document.getElementById('admin-arsip-menu').onclick = () => renderAdminArsipView();

    // --- FUNGSI HALAMAN SISWA ---
    async function renderTugasView() {
        updateView('tugas-view');
        const listDiv = document.getElementById('assignment-list-siswa');
        showLoading('Memuat tugas...');
        try {
            // [PATH v9+ & SINTAKS v9+] Menggunakan query(), collection(), orderBy(), getDocs()
            // Ambil SEMUA tugas dulu
            const assignmentsQuery = query(collection(db, 'assignments'), orderBy('createdAt', 'desc')); // (DIKEMBALIKAN)
            const assignmentsSnap = await getDocs(assignmentsQuery);
            const assignments = assignmentsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            // [PATH v9+ & SINTAKS v9+]
            const submissionsQuery = query(collection(db, 'submissions'), where('studentUid', '==', currentUserData.uid)); // (DIKEMBALIKAN)
            const submissionsSnap = await getDocs(submissionsQuery);
            studentSubmissions = {};
            submissionsSnap.docs.forEach(doc => { studentSubmissions[doc.data().assignmentId] = { id: doc.id, ...doc.data() }; });

            // [PERBAIKAN] Filter tugas berdasarkan semester siswa secara ketat
            const userSemester = parseInt(currentUserData.semester) || 1; // Ambil semester siswa (default 1)
            const filteredAssignments = assignments.filter(a => {
                // Tentukan semester tugas: jika tidak ada, anggap sebagai 1
                const taskSemester = a.semester !== undefined ? parseInt(a.semester) : 1;
                // Hanya tampilkan jika semester tugas sama persis dengan semester siswa
                return taskSemester === userSemester;
            });

            listDiv.innerHTML = '';
            // [MODIFIKASI] Cek 'filteredAssignments' bukan 'assignments'
            if (filteredAssignments.length === 0) { 
                listDiv.innerHTML = '<h3>Belum ada tugas untuk semester Anda saat ini.</h3>'; 
            } else {
                // [MODIFIKASI] Loop 'filteredAssignments' bukan 'assignments'
                filteredAssignments.forEach(a => {
                    const card = document.createElement('div');
                    card.className = 'item-card clickable';
                    const deadline = new Date(a.deadline);
                    const isSubmitted = studentSubmissions[a.id];
                    
                    // Tambah informasi semester
                    const taskSemester = a.semester !== undefined ? a.semester : 1;
                    const semesterInfo = `<p><strong>Semester:</strong> ${taskSemester}</p>`;
                    
                    card.innerHTML = `${isSubmitted ? '<i class="fa-solid fa-check-circle submitted-icon"></i>' : ''}<h3>${a.judul}</h3><p>${a.mapel}</p>${semesterInfo}<p><strong>Deadline:</strong> ${deadline.toLocaleString('id-ID')}</p>`;
                    card.onclick = () => showTaskDetail(a);
                    listDiv.appendChild(card);
                });
            }
        } catch(err) { listDiv.innerHTML = '<p>Gagal memuat data tugas.</p>'; console.error(err); }
        finally { hideLoading(); }
    }
    function showTaskDetail(assignment) {
        updateView('task-detail-view');
        const detailView = document.getElementById('task-detail-view');
        const isSubmitted = studentSubmissions[assignment.id];

        let contentHTML = `<button class="btn btn-secondary back-to-tugas-view" style="width:auto; margin-bottom:20px;"><i class="fa-solid fa-arrow-left"></i> Kembali</button>`;

        if (isSubmitted) {
            let gradeInfoHTML = '';
            if (isSubmitted.nilai !== null && isSubmitted.nilai !== undefined && isSubmitted.nilai !== '') {
                gradeInfoHTML = `<p>Tugas Anda telah dinilai oleh pengajar.</p><button id="check-grade-btn" class="btn" style="width: auto; margin-top: 15px;">Cek Nilai</button>`;
            } else {
                gradeInfoHTML = `<p>Tugas Anda sedang menunggu penilaian dari pengajar.</p>`;
            }
            contentHTML += `<div class="submission-success-view"><i class="fa-solid fa-paper-plane"></i><h3>Tugas Terkirim</h3>${gradeInfoHTML}</div>`;
        } else {
            const deadline = new Date(assignment.deadline);
            const isClosed = new Date() > deadline;
            let formHTML = '';
            if (isClosed) { formHTML = '<div class="tag tag-gray" style="text-align:center;padding:12px;">Tugas sudah ditutup.</div>'; }
            else {
                if (assignment.tipe === 'Esai') { formHTML = `<form id="submit-form"><div class="form-group"><label>Jawaban Esai Anda</label><textarea id="jawaban-teks" rows="10" required class="form-control"></textarea></div><button type="submit" class="btn">Kirim Jawaban</button></form>`; }
                else if (assignment.tipe === 'Dokumen') { formHTML = `<form id="submit-form"><div class="form-group"><label>Unggah File (Maks 2MB)</label><input type="file" id="jawaban-file" required class="form-control"></div><button type="submit" class="btn">Kirim File</button></form>`; }
            }
            contentHTML += `<h2>${assignment.judul}</h2><p><strong>Oleh:</strong> ${assignment.namaPengajar}</p><p><strong>Instruksi:</strong> ${assignment.instruksi}</p><hr>${formHTML}`;
        }

        detailView.innerHTML = contentHTML;
        detailView.querySelector('.back-to-tugas-view').onclick = renderTugasView;

        const checkGradeBtn = detailView.querySelector('#check-grade-btn');
        if (checkGradeBtn) {
            checkGradeBtn.onclick = () => {
                const grade = isSubmitted.nilai;
                const feedback = isSubmitted.feedback || 'Tidak ada feedback.';
                showModal('Hasil Penilaian', `<div style="text-align: left;"><h4>Nilai Anda:</h4><div class="timer-display">${grade}</div><h4 style="margin-top: 15px;">Feedback dari Pengajar:</h4><p><em>${feedback}</em></p></div>`);
            };
        }

        const submitForm = detailView.querySelector('#submit-form');
        if (submitForm) {
            submitForm.onsubmit = async (e) => {
                e.preventDefault();
                if (await showModal('Konfirmasi', 'Tugas hanya dapat dikirim SATU KALI. Lanjutkan?', true)) {
                    showLoading('Mengirim tugas...');
                    try {
                        const payload = {
                            assignmentId: assignment.id, studentUid: currentUserData.uid, studentName: currentUserData.name,
                            submittedAt: serverTimestamp(), nilai: null, feedback: '' // [SINTAKS v9+] serverTimestamp()
                        };
                        if (assignment.tipe === 'Dokumen') {
                            const file = document.getElementById('jawaban-file').files[0];
                            if (!file) throw new Error('File belum dipilih.');
                            if (file.size > 2 * 1024 * 1024) throw new Error('Ukuran file melebihi 2MB.');
                            // [PATH v9+ & SINTAKS v9+] Menggunakan ref(storage, ...) dan uploadBytes()
                            const storageRef = ref(storage, `submissions/${assignment.id}/${currentUserData.uid}/${file.name}`); // (DIKEMBALIKAN)
                            const uploadTask = await uploadBytes(storageRef, file);
                            payload.fileUrl = await getDownloadURL(uploadTask.ref);
                            payload.fileName = file.name;
                        } else {
                            payload.jawabanTeks = document.getElementById('jawaban-teks').value;
                        }
                        // [PATH v9+ & SINTAKS v9+] Menggunakan addDoc(collection(db, ...))
                        const newSubmission = await addDoc(collection(db, 'submissions'), payload); // (DIKEMBALIKAN)
                        studentSubmissions[assignment.id] = { id: newSubmission.id, ...payload };
                        hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                        showTaskDetail(assignment);
                    } catch (error) { 
                        hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                        showModal('Error', 'Gagal mengirim tugas. ' + error.message); 
                    }
                }
            };
        }
    }
    
    // [BARU] Helper untuk Logging ke Firestore
    async function logKHSAccess(action) {
        try {
            await addDoc(collection(db, 'khs_access_logs'), {
                studentUid: currentUserData.uid,
                studentName: currentUserData.name,
                action: action, // 'VIEW' atau 'DOWNLOAD'
                timestamp: serverTimestamp()
            });
        } catch (e) {
            console.error("Gagal mencatat log:", e);
        }
    }

    // [BARU] Fungsi Render Kartu Studi (DESAIN BARU)
    window.renderKartuStudiView = function() {
        // 1. Cek Kelengkapan Nilai
        const requiredGrades = [
            'nilai_t1', 'nilai_t2', 'nilai_t3', 'nilai_t4', 
            'nilai_t5', 'nilai_t6', 'nilai_t7', 'nilai_t8', 
            'nilai_uts', 'nilai_uas'
        ];
        
        // Fungsi cek: nilai tidak boleh null, undefined, atau string kosong
        const isComplete = requiredGrades.every(key => 
            currentUserData[key] !== null && 
            currentUserData[key] !== undefined && 
            currentUserData[key] !== ''
        );

        if (!isComplete) {
            showModal('Akses Ditolak', 'Mohon maaf, Kartu Hasil Studi (KHS) belum dapat diakses karena penilaian belum lengkap. Silakan hubungi admin atau tunggu hingga seluruh nilai diinput.');
            return; // Stop eksekusi, jangan pindah view
        }

        // Jika lolos, catat log view
        logKHSAccess('VIEW');

        updateView('kartu-studi-view');
        const container = document.getElementById('kartu-studi-content');
        
        // Helper
        const formatScore = (val) => (val !== null && val !== undefined && val !== '') ? val : '-';
        
        // Data Mentah
        const t1 = parseFloat(currentUserData.nilai_t1) || 0; const t2 = parseFloat(currentUserData.nilai_t2) || 0;
        const t3 = parseFloat(currentUserData.nilai_t3) || 0; const t4 = parseFloat(currentUserData.nilai_t4) || 0;
        const t5 = parseFloat(currentUserData.nilai_t5) || 0; const t6 = parseFloat(currentUserData.nilai_t6) || 0;
        const t7 = parseFloat(currentUserData.nilai_t7) || 0; const t8 = parseFloat(currentUserData.nilai_t8) || 0;
        const uts = parseFloat(currentUserData.nilai_uts) || 0; const uas = parseFloat(currentUserData.nilai_uas) || 0;

        // Hitung Rata-rata per Mata Pelajaran (Asumsi 2 tugas per mapel)
        // Jika salah satu kosong, tetap dibagi 2 atau dianggap 0? Kita anggap 0.
        // Tapi untuk tampilan "Nilai", kita tampilkan dua-duanya seperti di gambar (85 | 78)
        
        // Fungsi helper untuk menghitung grade
        const getGrade = (avg) => {
            if (avg >= 85) return 'A';
            if (avg >= 75) return 'B';
            if (avg >= 60) return 'C';
            if (avg >= 50) return 'D';
            return 'E';
        };

        // Mata Pelajaran (Hardcoded sesuai gambar referensi, dipetakan ke Tugas 1-8)
        const subjects = [
            { no: 1, name: "Seni Menemukan Cerita", sks: 2, v1: formatScore(currentUserData.nilai_t1), v2: formatScore(currentUserData.nilai_t2), avg: (t1+t2)/2 },
            { no: 2, name: "Seni Menghidupkan Dunia", sks: 2, v1: formatScore(currentUserData.nilai_t3), v2: formatScore(currentUserData.nilai_t4), avg: (t3+t4)/2 },
            { no: 3, name: "Seni Menjalin Peristiwa", sks: 2, v1: formatScore(currentUserData.nilai_t5), v2: formatScore(currentUserData.nilai_t6), avg: (t5+t6)/2 },
            { no: 4, name: "Seni Memoles Naskah", sks: 2, v1: formatScore(currentUserData.nilai_t7), v2: formatScore(currentUserData.nilai_t8), avg: (t7+t8)/2 },
            { no: 5, name: "Ujian Tengah Semester", sks: 2, val: formatScore(currentUserData.nilai_uts), avg: uts, isExam: true },
            { no: 6, name: "Ujian Akhir Semester", sks: 2, val: formatScore(currentUserData.nilai_uas), avg: uas, isExam: true },
        ];

        let totalSKS = 12;
        let totalScore = 0;
        let validSubjects = 0;

        // Generate Rows
        let rowsHTML = '';
        subjects.forEach(s => {
            // Hitung total untuk IPS (kasar)
            if (s.avg > 0) {
                totalScore += s.avg;
                validSubjects++;
            }

            let nilaiCell = '';
            if (s.isExam) {
                nilaiCell = `<td colspan="2" style="text-align: center;">${s.val}</td>`;
            } else {
                nilaiCell = `<td style="border-right: 1px solid #000; width: 50px;">${s.v1}</td><td style="width: 50px;">${s.v2}</td>`;
            }

            // Grade hanya muncul jika nilai ada
            let grade = '';
            if ((s.isExam && s.val !== '-') || (!s.isExam && (s.v1 !== '-' || s.v2 !== '-'))) {
                grade = getGrade(s.avg);
            }

            rowsHTML += `
                <tr>
                    <td>${s.no}.</td>
                    <td style="text-align: left; padding-left: 15px;">${s.name}</td>
                    <td>${s.sks}</td>
                    ${nilaiCell}
                    <td>${grade}</td>
                </tr>
            `;
        });

        // Hitung IPS (Indeks Penilaian Semester) - Logika sederhana: Rata-rata total / 25 (skala 4)
        // Atau pakai data IPS yang sudah disimpan di user profile
        let displayIPS = (parseFloat(currentUserData.ips) || 0).toFixed(2);

        // Generate nomor dokumen unik
        const docNumber = `KHS-CA-${new Date().getFullYear()}-${currentUserData.uid.substring(0,5).toUpperCase()}`;
        const timestamp = new Date().getTime(); // [BARU] Timestamp untuk cache busting

        // Template HTML
        // [MODIFIKASI] Wrapper .khs-wrapper agar scrollable, tapi .khs-container ukurannya TETAP (fixed width)
        container.innerHTML = `
            <div class="khs-wrapper">
                <div id="khs-download-area" class="khs-container">
                    <!-- Watermark Logo Baru dengan CrossOrigin & Timestamp -->
                    <img src="https://i.imgur.com/HDC6SWw.png" class="khs-watermark" alt="Watermark Cendekia Aksara" crossorigin="anonymous">
                    
                    <div class="khs-header">
                        <!-- Logo Baru di Header dengan CrossOrigin & Timestamp -->
                        <div style="margin-bottom: 10px;">
                            <img src="https://i.imgur.com/HDC6SWw.png" alt="Logo Cendekia Aksara" style="height: 60px; display: block; margin: 0 auto;" crossorigin="anonymous">
                        </div>
                        <h2>KARTU HASIL STUDI</h2>
                        <p>Sekolah Menulis Gratis Cendekia Aksara</p>
                    </div>

                    <div class="khs-student-info">
                        <table>
                            <tr>
                                <td style="width: 120px;">Nama</td>
                                <td style="width: 10px;">:</td>
                                <td>${currentUserData.name}</td>
                            </tr>
                            <tr>
                                <td>ID Siswa</td>
                                <td>:</td>
                                <td>${currentUserData.uid.substring(0, 10).toUpperCase()}</td> <!-- Pakai UID sbg ID -->
                            </tr>
                            <tr>
                                <td>Semester</td>
                                <td>:</td>
                                <td>${currentUserData.semester || 1}</td>
                            </tr>
                        </table>
                    </div>

                    <table class="khs-table">
                        <thead>
                            <tr>
                                <th rowspan="2" style="width: 40px;">No.</th>
                                <th rowspan="2">Mata Pelajaran</th>
                                <th rowspan="2" style="width: 50px;">SKS</th>
                                <th colspan="2">Nilai</th>
                                <th rowspan="2" style="width: 60px;">Grade</th>
                            </tr>
                            <!-- Baris kosong untuk spacer header nilai, di-hidden karena merged di atas -->
                        </thead>
                        <tbody>
                            ${rowsHTML}
                            <tr style="font-weight: bold;">
                                <td colspan="2" style="text-align: right; padding-right: 15px; border-right: none;">Total</td>
                                <td style="border-left: none;">${totalSKS}</td>
                                <td colspan="3" style="background-color: #f0f0f0;"></td>
                            </tr>
                        </tbody>
                    </table>

                    <div class="khs-footer">
                        IPS (Indeks Penilaian Semester) : ${displayIPS}
                    </div>

                    <div class="khs-signature-section">
                        <div class="signature-box">
                            <p style="margin-bottom: 60px;">Mengetahui,<br>Kepala Cendekia</p>
                            
                            <!-- Cap Basah (Stempel) Gambar Baru dengan CrossOrigin & Timestamp -->
                            <img src="https://i.imgur.com/YvrNYRw.png" class="signature-stamp" alt="Stempel Sah" crossorigin="anonymous">

                            <p style="text-decoration: underline; font-weight: bold;">Mukhamad Bayu Aji</p>
                        </div>
                    </div>

                    <div class="khs-bottom-bar">
                        <strong>No. Dokumen:</strong> ${docNumber} <br>
                        <strong>Catatan:</strong> Kartu Hasil Studi ini diterbitkan secara elektronik oleh sistem Cendekia Aksara. Dokumen ini sah dan tidak memerlukan tanda tangan basah tambahan jika diunduh melalui portal resmi. Segala bentuk perubahan pada data dokumen ini adalah tindakan ilegal.
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 30px; text-align: center;">
                <p style="font-size: 0.8em; color: var(--gray-color);">Pastikan data sudah benar sebelum mengunduh.</p>
                <button onclick="downloadKHS()" class="btn btn-primary btn-sm" style="width: auto;">
                    <i class="fa fa-download"></i> Unduh KHS (HD)
                </button>
            </div>
        `;
    };

    // Fungsi Download HD
    window.downloadKHS = function() {
        // Catat log download
        logKHSAccess('DOWNLOAD');

        const element = document.getElementById('khs-download-area');
        
        // Opsi html2canvas untuk kualitas tinggi
        const options = {
            scale: 2, // 2x resolusi untuk ketajaman (HD)
            useCORS: true, // [PENTING] Mengaktifkan CORS untuk gambar eksternal
            // allowTaint: true, // [HAPUS] Ini menyebabkan taint error saat toDataURL
            backgroundColor: "#ffffff", // Pastikan background putih
            logging: true
        };

        showLoading('Menyiapkan dokumen...');
        
        // Tunggu sebentar agar gambar selesai di-render ulang dengan atribut crossorigin
        setTimeout(() => {
            html2canvas(element, options).then(canvas => {
                // Convert ke image
                const image = canvas.toDataURL("image/png", 1.0);
                
                // Trigger download
                const link = document.createElement('a');
                link.download = `KHS_${currentUserData.name}_Sem${currentUserData.semester || 1}.png`;
                link.href = image;
                link.click();
                
                hideLoading();
            }).catch(err => {
                console.error(err);
                hideLoading();
                alert("Gagal mengunduh gambar. Pastikan koneksi internet stabil.");
            });
        }, 1000); // Delay 1 detik untuk loading gambar
    }

    // [BARU] Fungsi Render Halaman Arsip Admin
    async function renderAdminArsipView() {
        updateView('admin-arsip-view');
        const tbody = document.getElementById('arsip-list-body');
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Memuat data...</td></tr>';
        
        try {
            // [PATH v9+ & SINTAKS v9+]
            const q = query(collection(db, 'khs_access_logs'), orderBy('timestamp', 'desc'), limit(50));
            const snapshot = await getDocs(q);
            
            tbody.innerHTML = '';
            
            if (snapshot.empty) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;">Belum ada aktivitas tercatat.</td></tr>';
                return;
            }

            snapshot.forEach(doc => {
                const log = doc.data();
                const date = log.timestamp ? log.timestamp.toDate().toLocaleString('id-ID') : '-';
                
                // Style badge berdasarkan tipe aksi
                const badgeClass = log.action === 'DOWNLOAD' ? 'log-download' : 'log-view';
                const actionLabel = log.action === 'DOWNLOAD' ? 'Mengunduh KHS' : 'Melihat KHS';
                const detailText = log.action === 'DOWNLOAD' ? 'Dokumen berhasil diunduh' : 'Akses halaman KHS';

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${date}</td>
                    <td><strong>${log.studentName}</strong></td>
                    <td><span class="log-badge ${badgeClass}">${actionLabel}</span></td>
                    <td>${detailText}</td>
                `;
                tbody.appendChild(tr);
            });
        } catch (err) {
            console.error("Gagal memuat arsip:", err);
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; color:red;">Gagal memuat data arsip.</td></tr>';
        }
    }

    // [MODIFIKASI] Halaman profil diubah menjadi formulir
    function renderProfilView() {
        updateView('profil-view');
        const contentDiv = document.getElementById('profil-content');
        const backBtn = document.querySelector('#profil-view .back-to-dashboard');
        
        // Cek kelengkapan data lagi
        const isDataLengkap = currentUserData.noHp && currentUserData.alamat;
        
        if (isDataLengkap) {
            backBtn.classList.remove('hidden');
        } else {
            backBtn.classList.add('hidden'); // Sembunyikan tombol kembali jika data belum lengkap
        }

        const initial = currentUserData.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();

        // [FIX] Tambahkan kembali tampilan Semester dan IPS
        const displayIPS = (parseFloat(currentUserData.ips) || 0).toFixed(2);
        
        // Tentukan kelas untuk foto profil berdasarkan IPS
        const ipsValue = parseFloat(currentUserData.ips) || 0;
        const profilePicClass = ipsValue < 3.0 ? 'warning' : 'good';
        
        // Ubah dari display statis menjadi form
        contentDiv.className = 'profile-info'; // Hapus 'item-card'
        contentDiv.innerHTML = `
            <div class="profile-pic ${profilePicClass}">${displayIPS}</div>
            <h3>${currentUserData.name}</h3>
            <p>${currentUserData.email}</p>
            
            ${ipsValue < 3.0 ? `
            <div class="ips-warning">
                <i class="fa-solid fa-exclamation-triangle"></i>
                <div>
                    <strong>Perhatian!</strong> IPS Anda di bawah 3.00. Segera hubungi wali kelas untuk mendapatkan nilai tambahan.
                </div>
            </div>
            ` : ''}

            <!-- [FIX] Bagian Semester & IPS ditambahkan kembali -->
            <div class="profile-details" style="margin-bottom: 25px;">
                <div class="detail-item">
                    <strong>Semester Saat Ini</strong>
                    <span>${currentUserData.semester || '1'}</span>
                </div>
                <div class="detail-item">
                    <strong>Indeks Penilaian Semester (IPS)</strong>
                    <span>${displayIPS}</span>
                </div>
            </div>
            <!-- Akhir bagian Semester & IPS -->

            <form id="profile-form">
                <div class="form-group" style="text-align: left;">
                    <label for="profile-name">Nama Lengkap</label>
                    <input type="text" id="profile-name" class="form-control" value="${currentUserData.name || ''}" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-email">Email (Tidak dapat diubah)</label>
                    <input type="email" id="profile-email" class="form-control" value="${currentUserData.email || ''}" readonly disabled style="background-color: #eee;">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-nohp">Nomor HP/WhatsApp</label>
                    <input type="tel" id="profile-nohp" class="form-control" value="${currentUserData.noHp || ''}" placeholder="cth: 08123456789" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-tgllahir">Tanggal Lahir</label>
                    <input type="date" id="profile-tgllahir" class="form-control" value="${currentUserData.tanggalLahir || ''}">
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-alamat">Alamat (Kota, Provinsi)</label>
                    <input type="text" id="profile-alamat" class="form-control" value="${currentUserData.alamat || ''}" placeholder="cth: Jakarta, DKI Jakarta" required>
                </div>
                <div class="form-group" style="text-align: left;">
                    <label for="profile-bio">Bio Singkat</label>
                    <textarea id="profile-bio" rows="3" class="form-control" placeholder="Ceritakan sedikit tentang diri Anda...">${currentUserData.bioSingkat || ''}</textarea>
                </div>
                <button type="submit" class="btn btn-success">Simpan Data Diri</button>
            </form>
        `;
    }

    // [BARU] Event listener untuk form profil siswa
    document.getElementById('profil-view').addEventListener('submit', async (e) => {
        if (e.target.id === 'profile-form') {
            e.preventDefault();
            showLoading('Menyimpan data...');
            const payload = {
                name: document.getElementById('profile-name').value,
                noHp: document.getElementById('profile-nohp').value,
                tanggalLahir: document.getElementById('profile-tgllahir').value,
                alamat: document.getElementById('profile-alamat').value,
                bioSingkat: document.getElementById('profile-bio').value,
            };

            // Validasi dasar
            if (!payload.name || !payload.noHp || !payload.alamat) {
                hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                showModal('Gagal', 'Nama, Nomor HP, dan Alamat wajib diisi.');
                return;
            }

            try {
                // [PATH v9+ & SINTAKS v9+]
                const userDocRef = doc(db, 'users', currentUserData.uid); // (DIKEMBALIKAN)
                await updateDoc(userDocRef, payload);

                // Update data di cache lokal
                Object.assign(currentUserData, payload);
                
                hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                await showModal('Sukses', 'Data diri berhasil diperbarui.');
                renderDashboardView(); // Arahkan kembali ke dashboard (yang sekarang akan lolos cek data)
            } catch (err) {
                hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                showModal('Error', 'Gagal menyimpan data: ' + err.message);
            }
        }
    });


    // --- FUNGSI HALAMAN ADMIN ---
    async function renderAdminTugasView() {
        updateView('admin-tugas-view');
        document.getElementById('create-assignment-form').reset();
        document.getElementById('edit-task-id').value = '';
        document.getElementById('cancel-edit-task-btn').classList.add('hidden');
        const listDiv = document.getElementById('admin-tugas-harian-list-admin');
        showLoading('Memuat daftar tugas...');
        try {
            // [PATH v9+ & SINTAKS v9+]
            const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc')); // (DIKEMBALIKAN)
            const snapshot = await getDocs(q);
            listDiv.innerHTML = '<h3>Daftar Tugas Terbit</h3>';
            
            // [TAMBAHAN] Penjelasan untuk admin
            listDiv.innerHTML += `
                <div style="background-color: #e7f3ff; border-left: 4px solid var(--primary-color); padding: 12px; margin-bottom: 15px; border-radius: 4px;">
                    <p style="margin: 0; font-size: 0.9em; color: var(--dark-text);">
                        <i class="fa-solid fa-info-circle" style="color: var(--primary-color); margin-right: 8px;"></i>
                        <strong>Info:</strong> Tugas yang dibuat sebelum adanya fitur 'Semester' secara otomatis dikategorikan sebagai <strong>'Semester 1 (Default)'</strong>. Untuk tugas baru, pastikan Anda memilih semester yang sesuai.
                    </p>
                </div>
            `;

            if (snapshot.empty) { listDiv.innerHTML += '<p>Belum ada tugas yang dibuat.</p>'; }
            else {
                snapshot.docs.forEach(doc => {
                    const task = {id: doc.id, ...doc.data()};
                    const card = document.createElement('div');
                    card.className = 'item-card';
                    
                    // [PERBAIKAN] Tampilkan semester dengan jelas
                    let semesterTag;
                    if (task.semester === undefined) {
                        semesterTag = '<span class="tag tag-gray" style="margin-left: 10px;">Semester 1 (Default)</span>';
                    } else {
                        semesterTag = `<span class="tag tag-blue" style="margin-left: 10px;">Semester ${task.semester}</span>`;
                    }
                    
                    card.innerHTML = `<div class="card-header"><h3>${task.judul} ${semesterTag}</h3><div class="card-actions"><button class="btn btn-secondary btn-icon btn-sm edit-task" data-id="${task.id}"><i class="fa fa-edit"></i></button><button class="btn btn-danger btn-icon btn-sm delete-task" data-id="${task.id}"><i class="fa fa-trash"></i></button></div></div><p>${task.mapel}</p>`;

                    listDiv.appendChild(card);
                });
            }
        } catch(err) { listDiv.innerHTML = '<p>Gagal memuat tugas.</p>'; }
        finally { hideLoading(); }
    }
    document.getElementById('create-assignment-form').onsubmit = async (e) => {
        e.preventDefault();
        const editId = document.getElementById('edit-task-id').value;
        const payload = {
            judul: document.getElementById('judul-tugas').value, mapel: document.getElementById('matkul-tugas').value,
            tipe: document.getElementById('tipe-tugas').value, instruksi: document.getElementById('instruksi-tugas').value,
            deadline: document.getElementById('deadline-tugas').value, namaPengajar: currentUserData.name,
            semester: parseInt(document.getElementById('semester-tugas').value, 10), // [BARU] Simpan sebagai angka
        };
        if (!editId) payload.createdAt = serverTimestamp(); // [SINTAKS v9+]
        showLoading('Menyimpan tugas...');
        try {
            // [PATH v9+ & SINTAKS v9+]
            if(editId) await updateDoc(doc(db, 'assignments', editId), payload); // (DIKEMBALIKAN)
            else await addDoc(collection(db, 'assignments'), payload); // (DIKEMBALIKAN)
            hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
            renderAdminTugasView();
        } catch (err) { 
            hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
            showModal('Error', 'Gagal menyimpan tugas.'); 
        }
    };
    document.getElementById('admin-tugas-harian-list-admin').addEventListener('click', async e => {
        const deleteBtn = e.target.closest('.delete-task');
        if (deleteBtn) {
            const taskId = deleteBtn.dataset.id;
            if (await showModal('Konfirmasi', 'Yakin ingin menghapus tugas ini?', true)) {
                showLoading('Menghapus...');
                try { 
                    // [PATH v9+ & SINTAKS v9+]
                    await deleteDoc(doc(db, 'assignments', taskId)); // (DIKEMBALIKAN)
                    renderAdminTugasView(); 
                }
                catch (err) { showModal('Error', 'Gagal menghapus tugas.'); } 
                finally { hideLoading(); }
            }
        }
        const editBtn = e.target.closest('.edit-task');
        if (editBtn) {
            const taskId = editBtn.dataset.id;
            showLoading('Memuat data tugas...');
            try {
                // [PATH v9+ & SINTAKS v9+]
                const docSnap = await getDoc(doc(db, 'assignments', taskId)); // (DIKEMBALIKAN)
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    document.getElementById('edit-task-id').value = taskId;
                    document.getElementById('judul-tugas').value = data.judul;
                    document.getElementById('matkul-tugas').value = data.mapel;
                    document.getElementById('tipe-tugas').value = data.tipe;
                    document.getElementById('instruksi-tugas').value = data.instruksi;
                    document.getElementById('deadline-tugas').value = data.deadline;
                    // [BARU] Set nilai semester saat edit
                    document.getElementById('semester-tugas').value = data.semester || '1'; // Default ke '1' jika blm ada
                    document.getElementById('cancel-edit-task-btn').classList.remove('hidden');
                    window.scrollTo(0, document.body.scrollHeight);
                }
            } catch(err) { showModal('Error', 'Gagal memuat data tugas.'); }
            finally { hideLoading(); }
        }
    });
    document.getElementById('cancel-edit-task-btn').onclick = () => {
        document.getElementById('create-assignment-form').reset();
        document.getElementById('edit-task-id').value = '';
        document.getElementById('cancel-edit-task-btn').classList.add('hidden');
    };
    async function renderAdminPenilaianView() {
        updateView('admin-penilaian-view');
        const assignmentSelector = document.getElementById('grading-assignment-selector');
        const studentGradingList = document.getElementById('student-grading-list');
        showLoading('Mempersiapkan halaman penilaian...');
        try {
            // [PATH v9+ & SINTAKS v9+]
            const q = query(collection(db, 'assignments'), orderBy('createdAt', 'desc')); // (DIKEMBALIKAN)
            const snapshot = await getDocs(q);
            const assignments = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            assignmentSelector.innerHTML = '<option value="">-- Pilih Tugas --</option>';
            assignments.forEach(a => { 
                const semesterInfo = a.semester !== undefined ? ` (Sem: ${a.semester})` : ' (Semester Tidak Ditentukan)';
                assignmentSelector.innerHTML += `<option value="${a.id}">${a.judul}${semesterInfo}</option>`; 
            }); 
            studentGradingList.innerHTML = '<p>Silakan pilih tugas untuk memulai penilaian.</p>';
        } catch(e) { studentGradingList.innerHTML = '<p>Gagal memuat daftar tugas.</p>'; }
        finally { hideLoading(); }
    }
    document.getElementById('grading-assignment-selector').onchange = async (e) => {
        const assignmentId = e.target.value;
        const studentGradingList = document.getElementById('student-grading-list');
        if (!assignmentId) {
            studentGradingList.innerHTML = '<p>Silakan pilih tugas untuk memulai penilaian.</p>';
            return;
        }
        showLoading('Memuat data jawaban siswa...');
        try {
            // [PATH v9+ & SINTAKS v9+]
            const q = query(collection(db, 'submissions'), where('assignmentId', '==', assignmentId)); // (DIKEMBALIKAN)
            const submissionsSnap = await getDocs(q);
            const submissions = submissionsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

            studentGradingList.innerHTML = '';
            if (submissions.length === 0) {
                studentGradingList.innerHTML = '<p>Belum ada siswa yang mengumpulkan tugas ini.</p>';
                hideLoading(); // [FIX] hideLoading() ditambahkan
                return;
            }
            submissions.sort((a, b) => (a.studentName || '').localeCompare(b.studentName || '')).forEach(submission => {
                const card = document.createElement('div');
                card.className = 'grading-card';
                const isGraded = submission.nilai !== null && submission.nilai !== undefined && submission.nilai !== '';
                const isDisabled = isGraded ? 'disabled' : '';
                const buttonText = isGraded ? 'Tersimpan' : 'Simpan Nilai';
                const buttonClass = isGraded ? 'btn-secondary' : 'btn-success';
                const statusTag = `<span class="tag ${isGraded ? 'tag-blue' : 'tag-green'}">${isGraded ? 'Sudah Dinilai' : 'Sudah Mengumpulkan'}</span>`;
                
                // [MODIFIKASI] Tampilkan jawaban esai dengan format
                let jawabanHTML = '';
                if (submission.fileUrl) {
                    jawabanHTML = `<p><strong>File:</strong> <a href="${submission.fileUrl}" target="_blank" class="btn btn-secondary download-link"><i class="fa fa-download"></i> Unduh (${submission.fileName || 'file'})</a></p>`;
                } else {
                    // [MODIFIKASI] Tampilkan jawaban dengan format newline
                    jawabanHTML = `<p style="text-align: left; margin-bottom: 5px;"><strong>Jawaban Siswa:</strong></p>
                                    <div style="border: 1px solid #ddd; padding: 12px; border-radius: 8px; background: #fdfdfd; max-height: 250px; overflow-y: auto; text-align: left; line-height: 1.5; white-space: normal;">
                                        ${nl2br(submission.jawabanTeks)}
                                    </div>`;
                }

                card.innerHTML = `
                    <div class="card-header"><h3>${submission.studentName}</h3>${statusTag}</div>
                    ${jawabanHTML}
                    <form class="grading-form" data-submission-id="${submission.id}">
                        <div class="form-group">
                            <label>Nilai:</label>
                            <input type="number" class="nilai-input form-control" min="0" max="100" value="${submission.nilai || ''}" ${isDisabled}>
                            <label>Feedback:</label>
                            <textarea rows="2" class="feedback-input form-control" ${isDisabled}>${submission.feedback || ''}</textarea>
                        </div>
                        <div class="grading-card-footer">
                            <button type="submit" class="btn ${buttonClass}" style="width: auto;" ${isDisabled}>${buttonText}</button>
                        </div>
                    </form>`;
                studentGradingList.appendChild(card);
            });
        } catch(e) { console.error('Gagal memuat data penilaian:', e); studentGradingList.innerHTML = '<p>Gagal memuat data penilaian.</p>'; }
        finally { hideLoading(); }
    };
    document.getElementById('student-grading-list').addEventListener('submit', async (e) => {
        if(e.target.classList.contains('grading-form')) {
            e.preventDefault();
            const form = e.target; const submissionId = form.dataset.submissionId;
            const btn = form.querySelector('button');
            const payload = { nilai: form.querySelector('.nilai-input').value, feedback: form.querySelector('.feedback-input').value };
            btn.disabled = true; showLoading('Menyimpan nilai...');
            try {
                // [PATH v9+ & SINTAKS v9+]
                await updateDoc(doc(db, 'submissions', submissionId), payload); // (DIKEMBALIKAN)
                hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                btn.textContent = 'Tersimpan';
                btn.classList.replace('btn-success', 'btn-secondary');
                form.querySelector('.nilai-input').disabled = true; form.querySelector('.feedback-input').disabled = true;
                const tag = form.closest('.grading-card').querySelector('.tag');
                if (tag) { tag.textContent = 'Sudah Dinilai'; tag.classList.replace('tag-green', 'tag-blue'); }
            } catch(err) { 
                hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                showModal('Error', 'Gagal menyimpan nilai.'); 
                btn.disabled = false; 
            }
        }
    });

    // [BARU] Fungsi untuk admin melihat data diri siswa
    async function renderAdminDataDiriView() {
        updateView('admin-data-diri-view');
        const listDiv = document.getElementById('data-diri-list');
        showLoading('Memuat data diri siswa...');
        listDiv.innerHTML = '';
        try {
            // [FIX] Hapus orderBy('name', 'asc') untuk menghindari error index
            // [PATH v9+ & SINTAKS v9+]
            const q = query(collection(db, 'users'), where('role', '==', 'siswa')); // (DIKEMBALIKAN)
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                listDiv.innerHTML = '<p style="text-align: center;">Belum ada data siswa.</p>';
            } else {
                // [FIX] Lakukan sorting di JavaScript setelah data diterima
                const users = snapshot.docs.map(doc => doc.data());
                users.sort((a, b) => (a.name || '').localeCompare(b.name || ''));

                // [FIX] Loop data yang sudah di-sort
                users.forEach(user => {
                    const card = document.createElement('div');
                    card.className = 'item-card'; // Pakai style item-card
                    card.innerHTML = `
                        <h3 style="text-align: left;">${user.name}</h3>
                        <p><strong>Email:</strong> ${user.email}</p>
                        <p><strong>No. HP:</strong> ${user.noHp || '<i>(Belum diisi)</i>'}</p>
                        <p><strong>Tgl. Lahir:</strong> ${user.tanggalLahir || '<i>(Belum diisi)</i>'}</p>
                        <p><strong>Alamat:</strong> ${user.alamat || '<i>(Belum diisi)</i>'}</p>
                        <p><strong>Bio:</strong> ${user.bioSingkat || '<i>(Belum diisi)</i>'}</p>
                    `;
                    listDiv.appendChild(card);
                });
            }
        } catch (err) {
            listDiv.innerHTML = `<p>Gagal memuat data: ${err.message}</p>`;
            console.error("Error loading student data diri:", err);
        } finally {
            hideLoading();
        }
    }

    // --- FUNGSI KELOLA PROFIL SISWA (DIMODIFIKASI & DIPERBAIKI) ---
    async function renderAdminProfilView() {
        updateView('admin-profil-view');
        showLoading('Memuat daftar siswa...');
        document.getElementById('search-user-input').value = '';
        document.getElementById('add-student-form').reset();
        const listDiv = document.getElementById('user-profile-list');
        listDiv.innerHTML = '';

        try {
            // 1. Ambil SEMUA siswa dari DB
            // [PATH v9+ & SINTAKS v9+]
            const q = query(collection(db, 'users'), where('role', '==', 'siswa')); // (DIKEMBALIKAN)
            const snapshot = await getDocs(q);

            // 2. Simpan SEMUA siswa ke cache utama
            allStudentsCache = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                .sort((a, b) => a.name.localeCompare(b.name));

            // [MODIFIKASI LOGIKA] Tampilkan SEMUA siswa, bukan hanya yg punya nilai
            displayedStudents = [...allStudentsCache];

            // 4. Gambar daftar siswa
            drawStudentProfileList(displayedStudents);
        } catch (err) {
            listDiv.innerHTML = '<p>Gagal memuat daftar siswa.</p>';
            console.error("Error loading student profiles:", err);
        } finally {
            hideLoading();
        }
    }

    // Fungsi untuk membuat KARTU profil siswa (dipanggil oleh drawStudentProfileList)
    function createStudentProfileCard(user) {
        const card = document.createElement('div');
        card.className = 'user-profile-card';
        card.id = `profile-card-${user.id}`; // Tambahkan ID unik

        // ?? '' digunakan untuk memastikan nilai tidak undefined saat ditampilkan
        const nilai = {
            t1: user.nilai_t1 ?? '', t2: user.nilai_t2 ?? '', t3: user.nilai_t3 ?? '', t4: user.nilai_t4 ?? '',
            t5: user.nilai_t5 ?? '', t6: user.nilai_t6 ?? '', t7: user.nilai_t7 ?? '', t8: user.nilai_t8 ?? '',
            uts: user.nilai_uts ?? '', uas: user.nilai_uas ?? ''
        };

        // [FIX] Pastikan user.ips adalah angka sebelum .toFixed()
        const displayIPS = (parseFloat(user.ips) || 0).toFixed(2);

        card.innerHTML = `
            <h4>${user.name}</h4>
            <p>${user.email}</p>
            <form class="profile-update-form" data-uid="${user.id}">
                <div class="form-group" style="margin-bottom: 10px;">
                    <label style="flex-basis: 100px;">Semester:</label>
                    <input type="number" class="semester-input form-control" value="${user.semester || 1}" min="1" style="width: 100px;">
                </div>

                <label style="font-weight: 600; margin-top: 15px; margin-bottom: 10px; display: block; border-top: 1px solid #eee; padding-top: 15px;">Input Nilai (Skala 0-100):</label>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px;">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 1" value="${nilai.t1}" min="0" max="100" title="Tugas 1">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 2" value="${nilai.t2}" min="0" max="100" title="Tugas 2">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 3" value="${nilai.t3}" min="0" max="100" title="Tugas 3">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 4" value="${nilai.t4}" min="0" max="100" title="Tugas 4">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 5" value="${nilai.t5}" min="0" max="100" title="Tugas 5">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 6" value="${nilai.t6}" min="0" max="100" title="Tugas 6">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 7" value="${nilai.t7}" min="0" max="100" title="Tugas 7">
                    <input type="number" class="nilai-input form-control" placeholder="Tugas 8" value="${nilai.t8}" min="0" max="100" title="Tugas 8">
                    <input type="number" class="nilai-input form-control" placeholder="UTS" value="${nilai.uts}" min="0" max="100" title="Nilai UTS" style="background-color: #f0f4f8; border: 2px solid var(--primary-color);">
                    <input type="number" class="nilai-input form-control" placeholder="UAS" value="${nilai.uas}" min="0" max="100" title="Nilai UAS" style="background-color: #f0f4f8; border: 2px solid var(--primary-color);">
                </div>

                <div class="form-group" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                    <button type="button" class="btn btn-secondary btn-sm hitung-rata-rata" style="width: auto;">Hitung Rata-rata</button>
                    <label style="flex-shrink: 0; margin-left: 10px; font-weight: 600;">Hasil IPS (0-4.00):</label>
                    <input type="text" class="ips-display form-control" value="${displayIPS}" readonly style="font-weight: bold; background-color: #eee; width: 80px;">
                    <button type="submit" class="btn btn-success btn-sm" style="width: auto; margin-left: auto;">Simpan Perubahan</button>
                </div>
            </form>
        `;
        return card;
    }

    // Fungsi untuk MENGGAMBAR ULANG list siswa (dipanggil load awal, filter, dan tambah manual)
    function drawStudentProfileList(usersToDraw) {
        const listDiv = document.getElementById('user-profile-list');
        listDiv.innerHTML = ''; // Kosongkan dulu

        if (usersToDraw.length === 0) {
            const searchTerm = document.getElementById('search-user-input').value;
            if (searchTerm) {
                listDiv.innerHTML = '<p>Tidak ada siswa yang cocok dengan filter pencarian.</p>';
            } else {
                // [MODIFIKASI] Pesan jika database memang kosong
                listDiv.innerHTML = '<p>Belum ada siswa dengan role "siswa" di database.</p>'; 
            }
            return;
        }

        usersToDraw.forEach(user => {
            const cardElement = createStudentProfileCard(user);
            listDiv.appendChild(cardElement);
        });
    }


    document.getElementById('search-user-input').onkeyup = (e) => {
        const searchTerm = e.target.value.toLowerCase();
        // [FIX] Filter dari CACHE UTAMA (allStudentsCache) agar bisa mencari semua
        const filteredStudents = allStudentsCache.filter(user => 
            user.name.toLowerCase().includes(searchTerm) || 
            user.email.toLowerCase().includes(searchTerm)
        );
        // [FIX] Simpan hasil filter ke displayedStudents
        displayedStudents = filteredStudents;
        drawStudentProfileList(displayedStudents); // Gambar ulang list yang sudah difilter
    };

    // --- LISTENER FORM TAMBAH SISWA BARU ---
    document.getElementById('add-student-form').onsubmit = async (e) => {
        e.preventDefault();
        const emailToAdd = document.getElementById('add-student-email').value.trim().toLowerCase();
        if (!emailToAdd) return;

        showLoading('Mencari siswa...');
        try {
            // 1. Cek apakah sudah ada di daftar yang TAMPIL (displayedStudents)
            // [FIX] Cek di CACHE UTAMA (allStudentsCache)
            const isAlreadyInCache = allStudentsCache.some(student => student.email.toLowerCase() === emailToAdd);
            
            if (isAlreadyInCache) {
                hideLoading();
                const existingStudent = allStudentsCache.find(s => s.email.toLowerCase() === emailToAdd);
                showModal('Info', `Siswa dengan email ${emailToAdd} sudah ada dalam daftar.`);
                
                // [FIX] Jika belum tampil (karena terfilter), tampilkan dia
                const isAlreadyDisplayed = displayedStudents.some(s => s.id === existingStudent.id);
                if (!isAlreadyDisplayed) {
                    document.getElementById('search-user-input').value = emailToAdd;
                    displayedStudents = [existingStudent];
                    drawStudentProfileList(displayedStudents);
                }

                if (existingStudent) {
                    const cardElement = document.getElementById(`profile-card-${existingStudent.id}`);
                    if (cardElement) {
                        cardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        cardElement.style.backgroundColor = '#fff3cd';
                        setTimeout(() => { cardElement.style.backgroundColor = ''; }, 2000);
                    }
                }
                return;
            }

            // 2. Cari di database (karena tidak ada di cache)
            let foundStudent = null;
            
            // [PATH v9+ & SINTAKS v9+] (DIUBAH)
            // [FIX] Hapus 'where role' agar bisa menemukan siswa yang role-nya kosong
            const q = query(collection(db, 'users'), where('email', '==', emailToAdd), limit(1)); // (DIKEMBALIKAN + MODIFIKASI)
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                hideLoading();
                showModal('Error', `Siswa dengan email ${emailToAdd} tidak ditemukan di database.`);
                return;
            }
            
            foundStudent = { id: snapshot.docs[0].id, ...snapshot.docs[0].data() };
            
            // --- [FIX BARU] Cek role sebelum menambahkan ---
            if (foundStudent.role === 'pengajar') {
                hideLoading();
                showModal('Info', `Tidak dapat menambahkan ${foundStudent.name}. Ini adalah akun pengajar.`);
                return;
            }

            // [FIX BARU] Jika role-nya BUKAN siswa (misal: kosong), update di database
            if (foundStudent.role !== 'siswa') {
                showLoading('Memperbarui role siswa...');
                // [PATH v9+ & SINTAKS v9+]
                const userDocRef = doc(db, 'users', foundStudent.id); // (DIKEMBALIKAN)
                // Pastikan data semester dan ips default juga di-set jika belum ada
                await updateDoc(userDocRef, { 
                    role: 'siswa',
                    semester: foundStudent.semester || 1,
                    ips: foundStudent.ips || 0
                });
                foundStudent.role = 'siswa'; // Update data lokal
                foundStudent.semester = foundStudent.semester || 1;
                foundStudent.ips = foundStudent.ips || 0;
            }
            // --- AKHIR FIX ---

            if (!allStudentsCache.some(s => s.id === foundStudent.id)) {
                allStudentsCache.push(foundStudent);
                allStudentsCache.sort((a, b) => a.name.localeCompare(b.name));
            }

            // 3. Tambahkan ke daftar yang TAMPIL (displayedStudents) dan gambar ulang
            // [FIX] Reset filter pencarian
            document.getElementById('search-user-input').value = '';
            displayedStudents = [...allStudentsCache]; // Tampilkan kembali semua

            drawStudentProfileList(displayedStudents);
            hideLoading();
            showModal('Sukses', `Siswa ${foundStudent.name} berhasil ditemukan/diperbarui dan ditambahkan ke daftar.`);
            document.getElementById('add-student-form').reset();

            const newCardElement = document.getElementById(`profile-card-${foundStudent.id}`);
            if (newCardElement) {
                newCardElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                newCardElement.style.backgroundColor = '#d1e7dd';
                setTimeout(() => { newCardElement.style.backgroundColor = ''; }, 2000);
            }

        } catch (err) {
            hideLoading();
            showModal('Error', 'Gagal mencari atau menambahkan siswa.');
            console.error("Error adding student:", err); // [FIX] Hapus 's' yang nyasar
        }
    };

    // --- LISTENER UNTUK KELOLA PROFIL ---
    document.getElementById('user-profile-list').addEventListener('click', (e) => {
        if (e.target.classList.contains('hitung-rata-rata')) {
            e.preventDefault();
            const form = e.target.closest('.profile-update-form');
            if (!form) return;

            const nilaiInputs = form.querySelectorAll('.nilai-input');
            let totalNilai = 0;
            let jumlahNilai = 0;

            nilaiInputs.forEach(input => {
                const nilai = parseFloat(input.value);
                // Hanya hitung jika nilai valid (angka) dan tidak kosong
                if (!isNaN(nilai) && input.value.trim() !== '') {
                    totalNilai += nilai;
                    jumlahNilai++;
                }
            });

            const rataRata = (jumlahNilai > 0) ? (totalNilai / jumlahNilai) : 0;
            const ips = (rataRata / 100) * 4;

            const ipsDisplay = form.querySelector('.ips-display');
            if (ipsDisplay) {
                ipsDisplay.value = ips.toFixed(2);
            }
        }
    });

    document.getElementById('user-profile-list').addEventListener('submit', async (e) => {
        if(e.target.classList.contains('profile-update-form')) {
            e.preventDefault();
            const form = e.target;
            const uid = form.dataset.uid;
            const btn = form.querySelector('button[type="submit"]');

            const nilaiInputs = form.querySelectorAll('.nilai-input');
            // Ambil nilai IPS yang sudah dihitung/ada di display
            const calculatedIPS = parseFloat(form.querySelector('.ips-display').value) || 0; // [FIX] .toFixed(2) dihapus, biarkan jadi angka

            const payload = {
                semester: parseInt(form.querySelector('.semester-input').value) || 1,
                ips: calculatedIPS, // Gunakan IPS dari display

                // Simpan 10 nilai (gunakan 'null' jika kosong)
                nilai_t1: nilaiInputs[0].value.trim() === '' ? null : parseFloat(nilaiInputs[0].value),
                nilai_t2: nilaiInputs[1].value.trim() === '' ? null : parseFloat(nilaiInputs[1].value),
                nilai_t3: nilaiInputs[2].value.trim() === '' ? null : parseFloat(nilaiInputs[2].value),
                nilai_t4: nilaiInputs[3].value.trim() === '' ? null : parseFloat(nilaiInputs[3].value),
                nilai_t5: nilaiInputs[4].value.trim() === '' ? null : parseFloat(nilaiInputs[4].value),
                nilai_t6: nilaiInputs[5].value.trim() === '' ? null : parseFloat(nilaiInputs[5].value),
                nilai_t7: nilaiInputs[6].value.trim() === '' ? null : parseFloat(nilaiInputs[6].value),
                nilai_t8: nilaiInputs[7].value.trim() === '' ? null : parseFloat(nilaiInputs[7].value),
                nilai_uts: nilaiInputs[8].value.trim() === '' ? null : parseFloat(nilaiInputs[8].value),
                nilai_uas: nilaiInputs[9].value.trim() === '' ? null : parseFloat(nilaiInputs[9].value),
            };

            showLoading('Menyimpan data...');
            btn.disabled = true;
            try {
                // [PATH v9+ & SINTAKS v9+]
                await updateDoc(doc(db, 'users', uid), payload); // (DIKEMBALIKAN)

                // Update data di cache utama (allStudentsCache)
                const userInAllCache = allStudentsCache.find(u => u.id === uid);
                if(userInAllCache) {
                    Object.assign(userInAllCache, payload);
                }
                // Update juga data di cache yang ditampilkan (displayedStudents)
                const userInDisplayedCache = displayedStudents.find(u => u.id === uid);
                if(userInDisplayedCache) {
                    Object.assign(userInDisplayedCache, payload);
                }

                hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                showModal('Sukses', 'Data profil siswa berhasil diperbarui.');
            } catch (err) {
                hideLoading(); // [FIX] Sembunyikan loading SEBELUM modal
                showModal('Error', 'Gagal memperbarui data.');
                console.error("Error saving profile:", err);
            } finally {
                btn.disabled = false;
            }
        }
    });
</script>
</body>
</html>
